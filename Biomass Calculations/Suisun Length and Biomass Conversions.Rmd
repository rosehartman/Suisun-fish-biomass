---
title: "R Notebook"
output: html_notebook
---

```{r}
pacman::p_load(data.table, readxl, dplyr, lubridate, tidyr, ggplot2, RODBC)

```


DOWNLOAD SUISUN DATA AND PRODUCE SPECIES LIST
-data tables used in Suisun Marsh Database:
Catch (catch #, length, by species)
Catch_Entry (see not below)
Depth (depth at regular temporal intervals during Otter & Mid Water trawl sampling -- not taken consistently)
Depth_Entry (see not below)
Sample (included method, station, date, WQ)
Sample_Entry (see not below)
SeineEffort (variables to calculate water volume sampled)
SledEffort (duration of tow)

NOTE: "..._Entry Tables" are for the most recent NOT QAQC'd data. These tables already have
      information contained in the "...Effort" Tables. The regular QAQC'd tables need to be 
      joing/merged with the Effort tables before rbinding like tables together.


The following Lookup Table were also downloaded for easy reference.
MethodsLookUp (sample gear used)
OrganismLookup (species names and codes)
StatiopnsLookUp (code & name of Station -- but no Lat Long :( )
TrawlEffort (duration of tow)
UnitsLookUp (units for all variables in Suisun Marsh database)
VariableCodesLookUp (for factorial variables, provides factor levels and description for each level)
VariablesLookUp (Description of all variables, and "type" of variable: 1 = continuous, 2 & 3 both seem 
                  to be factorial type fields, type 3 is specifically alphanumeric perhaps from lookup list, 
                  4 = informational such as comment field or samplers)
                                                                                   
NOTE: The CatchExpansion table contains a row for every fish caught by duplicating        
       CatchRowID and SampleRowID for every Count in d.catch, and assigning a      
       new field, "Record", assigned values of 1 to Count. The CatchExpansion 
       table will NOT be used in this analysis.                                               

```{r}
library(RODBC)    #loads the RODBC package
dta <- odbcConnectAccess2007("C:/Users/bharvey/Documents/Suisun Fish Biomass/Biomass Calculations/SuisunMarshFish2017_11_18_19_GuestPWuser.accdb", uid = "Guest", pwd = "user")   #opens database connection
df1 <- sqlFetch(dta, "bar")   #loads the table called 'bar' in the original Access file
df2 <- sqlFetch(dta, "bin")   #loads the table called 'bin' in the original Access file
```


```{r}
d.ageclass.by.month <- fread("AgesBySizeMo.txt", sep = ",")
d.catch1 <- fread("Catch.txt", sep = ",")
d.catch2 <- fread("Catch_Entry.txt", sep = ",")
# d.catchexpansion1 <- fread("CatchExpansion-part1.txt", sep = ",")
# d.catchexpansion2 <- fread("CatchExpansion-part2.txt", sep = ",")
d.depth1 <- fread("Depth.txt", sep = ",")
d.depth2 <- fread("Depth_Entry.txt", sep = ",")
d.methods <- fread("MethodsLookUp.txt", sep = ",")
d.organisms <- fread("OrganismsLookUp.txt", sep = ",")
d.sample1 <- fread("Sample.txt", sep = ",")
d.sample2 <- fread("Sample_Entry.txt", sep = ",")
d.seineeffort <- fread("SeineEffort.txt", sep = ",")
d.sledeffort <- fread("SledEffort.txt", sep = ",")
d.stations <- fread("StationsLookUp.txt", sep = ",")
d.trawleffort <- fread("TrawlEffort.txt", sep = ",")
d.units <- fread("UnitsLookUp.txt", sep = ",")
d.variablecodes <- fread("VariableCodesLookUp.txt", sep = ",")
d.variables <- fread("VariablesLookUp.txt", sep = ",")
```

GANG IT ALL UP
```{r}

# Drop columns that are not common between table sets
d.catch2[, EntryOrder := NULL]

# Join (merge) effort colums to d.sample1 to match columns in d.sample2
d.sample1.1 <- d.seineeffort[d.sample1, on = .(SampleRowID)]
d.sample1.1[, SeineRowID := NULL]
d.sample1.2 <- d.trawleffort[d.sample1.1, on = .(SampleRowID)]
d.sample1.2[, TrawlRowID := NULL]
d.sample1.3 <- d.sledeffort[d.sample1.2, on = .(SampleRowID)]
d.sample1.3[, SledRowID := NULL]
d.sample1.3[is.na(StartMeter & is.na(EndMeter)), ":=" (StartMeter = i.StartMeter, EndMeter = i.EndMeter)]
d.sample1.3[, i.StartMeter := NULL]
d.sample1.3[, i.EndMeter := NULL]

# Bind rows for table sets: catch, catchexpansion, depth, sample 
d.catch <- rbind(d.catch1, d.catch2)
# d.catchexpansion <- rbind(d.catchexpansion1, d.catchexpansion2)
d.depth <- rbind(d.depth1, d.depth2)
d.sample <- rbind(d.sample1.3, d.sample2)

#########################################################################################
### NOTE: d.depth is record of water depth at regular intervals during Otter and      ###
###       Midwater trawls. To use as variable, must average "Depth" by SampleRowID.   ###
###       Then join to d.sample on SampleRowID. Depth does not exist for ever Sample. ###
#########################################################################################
d.depth.avg <- d.depth[, .(depth.avg = mean(Depth)), by = (SampleRowID)] 

# JOIN IT ALL UP
d.suisun <- d.depth.avg[d.sample[d.catch, on = .(SampleRowID)], on = .(SampleRowID)]


#########################################################################################
### NOTE: start and stop meter readings are used to estimate water velocity. Average  ###
###       Velocity multipled by net opening and tow duration is roughly equivalent    ###
###       the volume of water sampled -- important for density estimates and          ###
###       comparability between gear types. Since these values were not consistently  ###
###       taken, we will likely use duration as an index, and enter gear type as a    ###
###       factor to remove this source of variability from comparisons with other     ###
###       variables of greater interest, like season and proximity to outfalls.       ###
#########################################################################################



############ DIAGNOSTIC ZONE
str(d.catch)
str(d.catchexpansion)
str(d.depth)
str(d.suisun)


```

d.suisun

Classes ‘data.table’ and 'data.frame':	254161 obs. of  35 variables:
 $ SampleRowID        : chr  "{6D860C58-C28F-4421-A5EA-06D92E7C75DA}" "{F9321141-9B2D-49E0-9582-D02E9D1D342A}" "{490F4873-8947-4352-81C9-3AA475D5FEEE}" "{B9A6750D-C354-4F3D-B086-8A23A34CF95A}" ...
 $ depth.avg          : num  1.44 NA 3.15 2.5 3.04 3.06 3.16 NA NA NA ...
 $ StartMeter         : int  NA NA NA NA NA NA NA NA NA NA ...
 $ EndMeter           : int  NA NA NA NA NA NA NA NA NA NA ...
 $ TotalMeter         : int  NA NA NA NA NA NA NA NA NA NA ...
 $ SledComments       : logi  NA NA NA NA NA NA ...
 $ TowDuration        : num  5 NA 10 5 5 5 10 5 5 NA ...
 $ TrawlComments      : chr  "" NA "" "" ...
 $ SeineDirectionCode : chr  NA "" NA NA ...
 $ SeineLength        : num  NA 20 NA NA NA NA NA NA NA 20 ...
 $ SeineWidth         : num  NA 10 NA NA NA NA NA NA NA 10 ...
 $ SeineDepth         : num  NA NA NA NA NA NA NA NA NA 1.03 ...
 $ SeineComments      : chr  NA "RT maybe smolt, very silvery" NA NA ...
 $ MethodCode         : chr  "OTR" "BSEIN" "OTR" "OTR" ...
 $ StationCode        : chr  "DV1" "DV2" "SU3" "PT1" ...
 $ SampleDate         : chr  "9/6/2017 0:00:00" "1/17/2002 0:00:00" "7/13/2004 0:00:00" "11/7/2018 0:00:00" ...
 $ SampleTime         : chr  "12/30/1899 7:45:00" "12/30/1899 12:50:00" "12/30/1899 13:22:00" "12/30/1899 10:20:00" ...
 $ QADone             : int  1 1 1 1 1 1 1 1 1 1 ...
 $ GearID             : logi  NA NA NA NA NA NA ...
 $ WaterTemperature   : num  22.9 8.2 22.1 14.8 9.9 16.2 18.8 24.2 9.3 10.7 ...
 $ Salinity           : num  3.7 1.7 7.5 6.1 4.1 8.5 5.4 1.3 0.9 6.2 ...
 $ DO                 : num  4.9 7.8 9.8 3.8 9.1 6.3 6.5 6.1 10 8.55 ...
 $ PctSaturation      : num  58 69 98 38 82 67 71 74 86 80.4 ...
 $ Secchi             : num  16 18 33 26 48 43 23 25 26 29 ...
 $ SpecificConductance: int  6690 3183 13010 10768 7458 14567 9528 2596 1800 10850 ...
 $ TideCode           : chr  "outgoing" "" "incoming" "incoming" ...
 $ UserName           : chr  "taorear" "katie" "alis" "taorear" ...
 $ CatchRowID         : chr  "{00007BF5-CFBF-4A26-993C-0343A8BFE649}" "{0000D40F-3D00-4278-86A0-CA6EBF49B5B9}" "{00013FCC-6929-4187-A57B-CB2672D978DF}" "{00021ACF-5AA8-4169-A71A-94BC6D344922}" ...
 $ OrganismCode       : chr  "TP" "CS" "TP" "CP" ...
 $ StandardLength     : num  63 32 132 185 138 97 113 120 98 71 ...
 $ Dead               : chr  "n/p" "n/p" "n/p" "n/p" ...
 $ Weight             : num  0 0 0 0 0 0 0 0 0 0 ...
 $ Sex                : chr  "n/p" "n/p" "n/p" "n/p" ...
 $ Count              : int  1 1 1 1 1 1 1 1 1 1 ...
 $ CatchComments      : chr  "" "" "" "" ...
 - attr(*, ".internal.selfref")=<externalptr> 
_________________________________________________________________________________________________
PRODUCE LENGTH CONVERSION TABLE
```{r}
d.fx3 <- fread("FX3_SwimTable.csv")

setnames(d.fx3, 
         old = colnames(d.fx3),
         new = c(
            "species",
            "common",
            "convert.tl.sl",
            "convert.tl.fl",
            "reference"
))


d.convert.length <- unique(d.fx3[species != "", .(species, common, convert.tl.sl, convert.tl.fl)][order(common)]) 
```


PRODUCE LENGTH TO BIOMASS CONVERSION TABLE
```{r}
d.kimmerer <- fread("Kimmerer L-W Table.csv")
# note: for Kimmerer, mass = slope * (length ^ exponent)
setnames(d.kimmerer, 
         old = colnames(d.kimmerer),
         new = c(
            "common",
            "species",
            "convert.slope",
            "convert.exponent",
            "length.type",
            "convert.fl2tl.Kimmerer",
            "convert.tl2sl.Kimmerer",
            "nothing_col",
            "reference"
))


############################ DIAGNOSTIC ZONE ############################
paste(str(d.convert.length), str(d.kimmerer))
# join conversion table data to species list from suisun to see what we have and what we need
merge(a, b, by = "dog", all = TRUE)


```


NEXT STEPS
- merge two above tables and compare length conversion factors
- figure out if they are a major component of assemblage
- calculate biomass!